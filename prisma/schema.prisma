generator client {
  provider = "prisma-client"
  output   = "../src/lib/prisma/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

//
// ENUMS
//

enum Role {
  USER
  ADMIN
}

enum NotificationType {
  NEW_MESSAGE
  NEW_LISTING
  SAVED_SEARCH_MATCH
}

enum PriceUnit {
  UNIT
  KG
  L
}

enum ContactMethod {
  NONE
  EMAIL
  PHONE
  BOTH
}

//
// AUTH & USERS
//

model User {
  id            String  @id @default(uuid())
  email         String  @unique
  name          String?
  password      String?
  role          Role    @default(USER)
  emailVerified Boolean @default(false)
  image         String?

  // ‚≠ê Reputation
  ratingAverage Float @default(0)
  ratingCount   Int   @default(0)
  ratingSum     Int   @default(0)

  salesCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions Session[]
  accounts Account[]

  listings Listing[]
  messages Message[] @relation("UserMessages")

  conversations        ConversationParticipant[]
  contactConversations Conversation[]            @relation("contactUser")

  bookmarks     Bookmark[]
  notifications Notification[]
  savedSearches SavedSearch[]

  receivedReviews Review[] @relation("SellerReviews")
  writtenReviews  Review[] @relation("AuthorReviews")

  @@map("user")
}

model Session {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(uuid())
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

//
// MARKETPLACE
//

model Category {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())

  parentId String?
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")

  listingsAsCategory    Listing[] @relation("ListingCategory")
  listingsAsSubCategory Listing[] @relation("ListingSubCategory")

  notifications Notification[]

  @@index([parentId])
  @@map("category")
}


model Location {
  id String @id @default(uuid())

  region     String
  department String
  city       String
  postalCode String
  lat        Float
  lng        Float

  createdAt DateTime @default(now())

  listings      Listing[]
  notifications Notification[]

  @@index([region])
  @@index([department])
  @@index([city])
  @@map("location")
}

model Listing {
  id String @id @default(uuid())

  title       String
  description String

  price     Float
  priceUnit PriceUnit
  quantity  Int?

  // Vente
  isSold Boolean   @default(false)
  soldAt DateTime?

  contactMethod ContactMethod @default(NONE)
  contactEmail  String?
  contactPhone  String?

  isActive   Boolean   @default(true)
  archivedAt DateTime?
  deletedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîó Foreign keys
  ownerId       String
  categoryId    String
  subCategoryId String
  locationId    String

  // üîó Relations
  owner       User     @relation(fields: [ownerId], references: [id])
  category    Category @relation("ListingCategory", fields: [categoryId], references: [id])
  subCategory Category @relation("ListingSubCategory", fields: [subCategoryId], references: [id])
  location    Location @relation(fields: [locationId], references: [id])

  images        ListingImage[]
  conversations Conversation[]
  bookmarks     Bookmark[]
  notifications Notification[]

  review Review?

  @@index([ownerId])
  @@index([categoryId])
  @@index([subCategoryId])
  @@map("listing")
}

model ListingImage {
  id        String   @id @default(uuid())
  listingId String
  url       String
  altText   String?
  createdAt DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@map("listing_image")
}

//
// MESSAGING
//

model Conversation {
  id            String   @id @default(uuid())
  listingId     String
  contactUserId String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  listing     Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  contactUser User    @relation("contactUser", fields: [contactUserId], references: [id])

  participants ConversationParticipant[]
  messages     Message[]

  @@unique([listingId, contactUserId])
  @@index([listingId])
  @@map("conversation")
}

model ConversationParticipant {
  conversationId String
  userId         String

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([conversationId, userId])
  @@map("conversation_participant")
}

model Message {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  readBy    String[] @default([])

  conversationId String
  senderId       String

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("UserMessages", fields: [senderId], references: [id], onDelete: Cascade)

  notifications Notification[]

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("message")
}

//
// SOCIAL / UTILS
//

model Bookmark {
  userId    String
  listingId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@id([userId, listingId])
  @@map("bookmark")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  content   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  listingId  String?
  messageId  String?
  categoryId String?
  locationId String?

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing  Listing?  @relation(fields: [listingId], references: [id])
  message  Message?  @relation(fields: [messageId], references: [id])
  category Category? @relation(fields: [categoryId], references: [id])
  location Location? @relation(fields: [locationId], references: [id])

  @@index([userId, isRead])
  @@map("notification")
}

model SavedSearch {
  id          String    @id @default(uuid())
  userId      String
  title       String?
  query       Json
  isActive    Boolean   @default(true)
  lastChecked DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([lastChecked])
  @@map("saved_search")
}

model Review {
  id String @id @default(uuid())

  rating  Int // 1‚Äì5
  comment String?

  sellerId  String
  authorId  String
  listingId String @unique

  seller  User    @relation("SellerReviews", fields: [sellerId], references: [id])
  author  User    @relation("AuthorReviews", fields: [authorId], references: [id])
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([authorId, listingId]) // 1 review per buyer per listing
  @@index([sellerId])
  @@map("review")
}


